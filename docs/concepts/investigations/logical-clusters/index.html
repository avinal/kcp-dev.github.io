<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.104.1"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Logical clusters | kcp – a Kubernetes-like multi-tenant control plane</title><meta name=description content="Investigation on logical clusters
"><meta property="og:title" content="Logical clusters"><meta property="og:description" content="Investigation on logical clusters
"><meta property="og:type" content="article"><meta property="og:url" content="http://kcp-dev.github.io/docs/concepts/investigations/logical-clusters/"><meta property="article:section" content="docs"><meta property="og:site_name" content="kcp – a Kubernetes-like multi-tenant control plane"><meta itemprop=name content="Logical clusters"><meta itemprop=description content="Investigation on logical clusters
"><meta itemprop=wordCount content="1749"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Logical clusters"><meta name=twitter:description content="Investigation on logical clusters
"><link rel=preload href=/scss/main.min.c65bd9d7eb2baaad4d2c30a0905cadbf15f5bd43173d18c70d61a6eee706a020.css as=style><link href=/scss/main.min.c65bd9d7eb2baaad4d2c30a0905cadbf15f5bd43173d18c70d61a6eee706a020.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-sm-row td-navbar"><a class="navbar-brand mr-2" style=display:flex;justify-content:center href=/><img class=navbar-logo src=/logo.png width=38px alt=logo></a>
<a class=navbar-brand style=display:flex;justify-content:center href=/><span class="font-weight-bold d-none d-sm-inline d-lg-none" style=font-size:.875rem>kcp</span>
<span class="font-weight-bold d-none d-lg-inline">kcp</span></a><div class="td-navbar-nav-scroll ml-sm-auto mt-0" id=main_navbar><ul class="navbar-nav mt-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/kcp-dev/kcp/blob/main/CONTRIBUTING.md target=_blank><span>Contribute</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/kcp-dev/kcp/ target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ title="Welcome to kcp Documentation" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-started-li><a href=/docs/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsgetting-started><span>Getting Started</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsconcepts-li><a href=/docs/concepts/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsconcepts><span>kcp Concepts</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsauthorization-li><a href=/docs/concepts/authorization/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsauthorization><span>Authorization</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptscache-server-li><a href=/docs/concepts/cache-server/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptscache-server><span>Cache Server</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptscluster-mapper-li><a href=/docs/concepts/cluster-mapper/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptscluster-mapper><span>Cluster Mapper</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptslocations-and-scheduling-li><a href=/docs/concepts/locations-and-scheduling/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptslocations-and-scheduling><span>Placement, Locations and Scheduling</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptssyncer-li><a href=/docs/concepts/syncer/ title="Registering Kubernetes Clusters using syncer" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptssyncer><span>Syncer</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsquickstart-tenancy-and-apis-li><a href=/docs/concepts/quickstart-tenancy-and-apis/ title="Quickstart: Tenancy and APIs" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsquickstart-tenancy-and-apis><span>Tenancy and APIs</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsconcepts-li><a href=/docs/concepts/concepts/ title="Terminology for control plane" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsconcepts><span>Terminology</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsvirtual-workspaces-li><a href=/docs/concepts/virtual-workspaces/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsvirtual-workspaces><span>Virtual Workspaces</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsworkspaces-li><a href=/docs/concepts/workspaces/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsworkspaces><span>Workspaces</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsconceptsdevelopers-li><a href=/docs/concepts/developers/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsconceptsdevelopers><span>Developers</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsdeveloperscontrollers-li><a href=/docs/concepts/developers/controllers/ title="Writing kcp-aware controllers" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsdeveloperscontrollers><span>kcp-aware controllers</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsdeveloperslibrary-usage-li><a href=/docs/concepts/developers/library-usage/ title="Using `kcp` as a library" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsdeveloperslibrary-usage><span>Library Usage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsdevelopersreleasing-li><a href=/docs/concepts/developers/releasing/ title="Publishing a new kcp release" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsdevelopersreleasing><span>Publishing</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsconceptsinvestigations-li><a href=/docs/concepts/investigations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsconceptsinvestigations><span>Investigations</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsconceptsinvestigationslogical-clusters-li><a href=/docs/concepts/investigations/logical-clusters/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docsconceptsinvestigationslogical-clusters><span class=td-sidebar-nav-active-item>Logical clusters</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsinvestigationsminimal-api-server-li><a href=/docs/concepts/investigations/minimal-api-server/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsinvestigationsminimal-api-server><span>Minimal API Server</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsinvestigationsself-service-policy-li><a href=/docs/concepts/investigations/self-service-policy/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsinvestigationsself-service-policy><span>Self-service policy</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsinvestigationstransparent-multi-cluster-li><a href=/docs/concepts/investigations/transparent-multi-cluster/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsinvestigationstransparent-multi-cluster><span>Transparent multi-cluster</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptskubectl-kcp-plugin-li><a href=/docs/concepts/kubectl-kcp-plugin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptskubectl-kcp-plugin><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscli-reference-li><a href=/docs/cli-reference/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscli-reference><span>CLI Reference</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp-li><a href=/docs/cli-reference/kcp/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp><span>kcp</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_crd-li><a href=/docs/cli-reference/kcp_crd/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_crd><span>kcp crd</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_crd_snapshot-li><a href=/docs/cli-reference/kcp_crd_snapshot/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_crd_snapshot><span>kcp crd snapshot</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workload-li><a href=/docs/cli-reference/kcp_workload/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workload><span>kcp workload</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workload_cordon-li><a href=/docs/cli-reference/kcp_workload_cordon/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workload_cordon><span>kcp workload cordon</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workload_drain-li><a href=/docs/cli-reference/kcp_workload_drain/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workload_drain><span>kcp workload drain</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workload_sync-li><a href=/docs/cli-reference/kcp_workload_sync/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workload_sync><span>kcp workload sync</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workload_uncordon-li><a href=/docs/cli-reference/kcp_workload_uncordon/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workload_uncordon><span>kcp workload uncordon</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workspace-li><a href=/docs/cli-reference/kcp_workspace/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workspace><span>kcp workspace</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workspace_create-li><a href=/docs/cli-reference/kcp_workspace_create/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workspace_create><span>kcp workspace create</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workspace_create-context-li><a href=/docs/cli-reference/kcp_workspace_create-context/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workspace_create-context><span>kcp workspace create-context</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workspace_current-li><a href=/docs/cli-reference/kcp_workspace_current/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workspace_current><span>kcp workspace current</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workspace_tree-li><a href=/docs/cli-reference/kcp_workspace_tree/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workspace_tree><span>kcp workspace tree</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscli-referencekcp_workspace_use-li><a href=/docs/cli-reference/kcp_workspace_use/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscli-referencekcp_workspace_use><span>kcp workspace use</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscrd-reference-li><a href=/docs/crd-reference/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscrd-reference><span>CRD Reference</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/kcp-dev/kcp-dev.github.io/tree/main/docs/content/en/docs/Concepts/investigations/logical-clusters.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/kcp-dev/kcp-dev.github.io/edit/main/docs/content/en/docs/Concepts/investigations/logical-clusters.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/kcp-dev/kcp-dev.github.io/new/main/docs/content/en/docs/Concepts/investigations/logical-clusters.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/kcp-dev/kcp-dev.github.io/issues/new?title=Logical%20clusters" class=td-page-meta--issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/kcp-dev/kcp/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#goal-getting-a-new-cluster-that-allows-a-team-to-add-extensions-efficiently-should-be-effectively-zero-cost>Goal: Getting a new cluster that allows a team to add extensions efficiently should be effectively zero cost</a><ul><li><a href=#constraint-a-naive-client-should-see-no-difference-between-a-physical-or-logical-cluster>Constraint: A naive client should see no difference between a physical or logical cluster</a></li><li><a href=#constraint-the-implementation-must-improve-isolation-within-a-single-process>Constraint: The implementation must improve isolation within a single process</a></li><li><a href=#constraint-we-should-improve-in-process-options-for-policy>Constraint: We should improve in-process options for policy</a></li></ul></li><li><a href=#areas-of-investigation>Areas of investigation</a></li><li><a href=#use-cases>Use cases</a><ul><li><a href=#as-a-developer-of-crds--controllers--extensions>As a developer of CRDs / controllers / extensions</a></li><li><a href=#as-an-infrastructure-admin>As an infrastructure admin</a></li><li><a href=#as-a-user-on-an-existing-kubernetes-cluster>As a user on an existing Kubernetes cluster</a></li></ul></li><li><a href=#progress>Progress</a><ul><li><a href=#logical-clusters-represented-as-a-prefix-to-etcd>Logical clusters represented as a prefix to etcd</a></li><li><a href=#zero-configuration-on-startup-in-local-dev>Zero configuration on startup in local dev</a></li><li><a href=#crd-virtualization-inheritance-and-normalization>CRD virtualization, inheritance, and normalization</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=http://kcp-dev.github.io/docs/>Documentation</a></li><li class=breadcrumb-item><a href=http://kcp-dev.github.io/docs/concepts/>kcp Concepts</a></li><li class=breadcrumb-item><a href=http://kcp-dev.github.io/docs/concepts/investigations/>Investigations</a></li><li class="breadcrumb-item active" aria-current=page><a href=http://kcp-dev.github.io/docs/concepts/investigations/logical-clusters/ aria-disabled=true class="btn-link disabled">Logical clusters</a></li></ol></nav><div class=td-content><h1>Logical clusters</h1><div class=lead>Investigation on logical clusters</div><header class=article-meta></header><p>Kubernetes evolved from and was influenced by earlier systems that had weaker internal tenancy than a general-purpose compute platform requires. The namespace, quota, admission, and RBAC concepts were all envisioned quite early in the project, but evolved with Kubernetes and not all impacts to future evolution were completely anticipated. Tenancy within clusters is handled at the resource and namespace level, and within a namespace there are a limited number of boundaries. Most organizations use either namespace or cluster separation as their primary unit of self service, with variations leveraging a rich ecosystem of tools.</p><p>The one concrete component that cannot be tenanted are API resources - from a Kubernetes perspective we have too much history and ecosystem to desire a change, and so intra-cluster tenancy will always be at its weakest when users desire to add diverse extensions and tools. In addition, controllers are practically limited to a cluster scope or a namespace scope by the design of our APIs and authorization models and so intra-cluster tenancy for extensions is particularly weak (you can&rsquo;t prevent an ingress controller from viewing &ldquo;all secrets&rdquo;).</p><p>Our admission chain has historically been very powerful and allowed deep policy to be enforced for tenancy, but the lack of a dynamic plugin model in golang has limited us to what can be accomplished to external RPC webhooks which have a number of significant performance and reliability impacts (especially when coupled to the cluster the webhook is acting on). If we want to have larger numbers of tenants or stronger subdivision, we need to consider improving the scalability of our policy chain in a number of dimensions.</p><p>Ideally, as a community we could improve both namespace and cluster tenancy at the same time in a way that provides enhanced tools for teams and organizations, addresses extensions holistically, and improves the reliability and performance of policy control from our control planes.</p><h2 id=goal-getting-a-new-cluster-that-allows-a-team-to-add-extensions-efficiently-should-be-effectively-zero-cost>Goal: Getting a new cluster that allows a team to add extensions efficiently should be effectively zero cost</h2><p>If a cluster is a desirable unit of tenancy, clusters should be amortized &ldquo;free&rdquo; and easy to operationalize as self-service. We have explored in the community a number of approaches that make new clusters cheaper (specifically <a href>virtual clusters</a>
in SIG-multi-tenancy, as well as the natural cloud vendor &ldquo;as-a-service&rdquo; options where they amortize the cost of many small clusters), but there are certain fundamental fixed costs that inflate the cost of those clusters. If we could make one more cluster the same cost as a namespace, we could dramatically improve isolation of teams as well as offering an advantage for more alignment on tenancy across the ecosystem.</p><h3 id=constraint-a-naive-client-should-see-no-difference-between-a-physical-or-logical-cluster>Constraint: A naive client should see no difference between a physical or logical cluster</h3><p>A logical cluster that behaves differently from a physical cluster is not valuable for existing tools. We would need to lean heavily on our existing abstractions to ensure clients see no difference, and to focus on implementation options that avoid reduplicating a large amount of the Kube API surface area.</p><h3 id=constraint-the-implementation-must-improve-isolation-within-a-single-process>Constraint: The implementation must improve isolation within a single process</h3><p>As clusters grow larger or are used in more complex fashion, the failure modes of a single process API server have received significant attention within the last few years. To offer cheaper clusters, we&rsquo;d have to also improve isolation between simultaneous clients and manage etcd usage, traffic, and both cpu and memory use at the control plane. These stronger controls would be beneficial to physical clusters and organizations running more complex clusters as well.</p><h3 id=constraint-we-should-improve-in-process-options-for-policy>Constraint: We should improve in-process options for policy</h3><p>Early in Kubernetes we discussed our options for extension of the core capability - admission control and controllers are the two primary levers, with aggregated APIs being an escape hatch for more complex API behavior (including the ability to wrap existing APIs or CRDs). We should consider options that could reduce the cost of complex policy such as making using the Kube API more library-like (to enable forking) as well as in-process options for policy that could deliver order of magnitude higher reliability and performance than webhooks.</p><h2 id=areas-of-investigation>Areas of investigation</h2><ol><li>Define high level user use cases</li><li>Prototype modelling the simplest option to enable <code>kcp</code> demo functionality and team subdivision</li><li>Explore client changes required to make multi-cluster controllers efficient</li><li>Support surfacing into a logical cluster API resources from another logical cluster</li><li>Layering RBAC so that changes in one logical cluster are additive to a source policy that is out of the logical cluster&rsquo;s control</li><li>Explore quota of requests, cpu, memory, and persistent to complement P&F per logical cluster with hard and soft limits</li><li>Explore making <code>kcp</code> usable as a library so that an extender could write Golang admission / hierarchal policy for logical clusters that reduces the need for external extension</li><li>Work through how a set of etcd objects could be moved to another etcd for sharding operations and keep clients unaware (similar to the &ldquo;restore a cluster from backup&rdquo; problem)</li><li>Explore providing a read only resource underlay from another logical cluster so that immutable default objects can be provided</li><li>Investigate use cases that would benefit even a single cluster (justify having this be a feature in kube-apiserver on by default)</li></ol><h2 id=use-cases>Use cases</h2><p>The use cases of logical cluster can be seen to overlap heavily with <a href=/docs/concepts/investigations/transparent-multi-cluster/>transparent multi-cluster</a>
use cases, and are captured at the highest level in <a href>GOALS.md</a>
. The use cases below attempt to focus on logical clusters independent of the broader goals.</p><h3 id=as-a-developer-of-crds--controllers--extensions>As a developer of CRDs / controllers / extensions</h3><ul><li>I can launch a local Kube control plane and test out multiple different versions of the same CRD in parallel quickly</li><li>I can create a control plane for my organization&rsquo;s cloud resources (CRDs) that is centralized but doesn&rsquo;t require me to provision nodes.</li></ul><h3 id=as-an-infrastructure-admin>As an infrastructure admin</h3><ul><li>I can have strong tenant separation between different application teams</li><li>Allow tenant teams to run their own custom resources (CRDs) and controllers without impacting others</li><li>Subdivide access to the underlying clusters, keep those clusters simpler and with fewer extensions, and reduce the impact of cluster failure</li></ul><h3 id=as-a-user-on-an-existing-kubernetes-cluster>As a user on an existing Kubernetes cluster</h3><ul><li>I can get a temporary space to test an extension before installing it</li><li>I can create clusters that have my own namespaces</li></ul><h2 id=progress>Progress</h2><h3 id=logical-clusters-represented-as-a-prefix-to-etcd>Logical clusters represented as a prefix to etcd</h3><p>In the early prototype stage <code>kcp</code> has a series of patches that allow a header or API prefix path to alter the prefix used to retrieve resources from etcd. The set of available resources is stripped down to a minimal set of hardcoded APIs including namespaces, rbac, and crds by patching those out of kube-apiserver type registration.</p><p>The header <code>X-Kubernetes-Cluster</code> supports either a named logical cluster or the value <code>*</code>, or the prefix <code>/cluster/&lt;name></code> may be used at the root. This alters the behavior of a number of components, primarily retrieval and storage of API objects in etcd by adding a new segment to the etcd key (instead of <code>/&lt;resource>/&lt;namespace>/&lt;name></code>, <code>/&lt;resource>/&lt;cluster>/&lt;namespace>/&lt;name></code>). Providing <code>*</code> is currently acting on watch to support watching resources across all clusters, which also has the side effect of populating the object <code>metadata.clusterName</code> field. If no logical cluster name is provided, the value <code>admin</code> is used (which behaves as a normal kube-apiserver would).</p><p>This means new logical clusters start off empty (no RBAC or CRD resources), which the <code>kcp</code> prototype mitigates by calculating the set of API resources available by merging from the default <code>admin</code> CRDs + the hardcoded APIs. That demonstrates one avenue of efficiency - a new logical cluster has an amortized cost near zero for both RBAC (no duplication of several hundred RBAC roles into the logical cluster) and API OpenAPI documents (built on demand as the union of another logical cluster and any CRDs added to the new cluster).</p><p>To LIST or WATCH these resources, the user specifies <code>*</code> as their cluster name which adjusts the key prefix to fetch all resources across all logical clusters. It&rsquo;s likely some intermediate step between client and server would be necessary to support &ldquo;watch subset&rdquo; efficiently, which would require work to better enable clients to recognize the need to relist as well as the need to make the prototype support some level of logical cluster subset retrieval besides just an etcd key prefix scan.</p><h4 id=next-steps>Next steps</h4><ul><li>Continuing to explore how clients might query multiple resources across multiple logical clusters</li><li>What changes to resource version are necessary to allow</li></ul><h3 id=zero-configuration-on-startup-in-local-dev>Zero configuration on startup in local dev</h3><p>The <code>kcp</code> binary embeds <code>etcd</code> in a single node config and manages it for local iterative development. This is in keeping with optimize for local workflow, but can be replaced by connecting to an existing etcd instance (not currently implemented). Ideally, a <code>kcp</code> like process would have minimal external dependencies and be capable of running in a shardable configuration efficiently (each shard handling 100k objects), with other components handling logical cluster sharding.</p><h3 id=crd-virtualization-inheritance-and-normalization>CRD virtualization, inheritance, and normalization</h3><p>A simple implementation of CRD virtualization (different logical clusters having different api resources), CRD inheritance (a logical cluster inheriting CRDs from a parent logical cluster), and CRD normalization (between multiple physical clusters) to find the lowest-common-denominator resource has been prototyped.</p><p>The CRD structure in the kube-apiserver is currently &ldquo;up front&rdquo; (as soon as a CRD is created it shows up in apiresources), but with the goal of reducing the up front cost of a logical cluster we may wish to suggest refactors upstream that would make the model more amenable to &ldquo;on demand&rdquo; construction and merging at runtime. OpenAPI merging is a very expensive part of the kube-apiserver historically (rapid CRD changes can have a massive memory and CPU impact) and this may be a logical area to invest to allow scaling within regular clusters.</p><p>Inheritance allows an admin to control which resources a client might use - this would be particularly useful in more opinionated platform flows for organizations that wish to offer only a subset of APIs. The simplest approach here is that all logical clusters inherit the admin virtual cluster (the default), but more complicated flows with policy and chaining should be possible.</p><p>Normalization involves reading OpenAPI docs from one or more child clusters, converting those to CRDs, finding the lowest compatible version of those CRDs (the version that shares all fields), and materializing those objects as CRDs in a logical cluster. This allows the minimum viable hook for turning a generic control plane into a spot where real Kube objects can run, and would be a key part of transparent multi-cluster.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/kcp-users aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/kcp aria-label=Twitter><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/kcp-dev/kcp aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel=noopener href=https://kubernetes.slack.com/archives/C021U8WSAFK aria-label=Slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/kcp-dev aria-label="Developer mailing list"><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The kcp Authors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.ba3bfc0811f5d495647f814aadc74b292c03300cc581e5cdb379e6ad54046b52.js integrity="sha256-ujv8CBH11JVkf4FKrcdLKSwDMAzFgeXNs3nmrVQEa1I=" crossorigin=anonymous></script></body></html>