<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.102.3"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/kcp-dev.github.io/favicons/favicon.ico><link rel=apple-touch-icon href=/kcp-dev.github.io/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/kcp-dev.github.io/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/kcp-dev.github.io/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/kcp-dev.github.io/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/kcp-dev.github.io/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/kcp-dev.github.io/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/kcp-dev.github.io/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/kcp-dev.github.io/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/kcp-dev.github.io/favicons/android-192x192.png sizes=192x192><title>kcp Multi-Cluster Architecture | kcp</title><meta name=description content="This doc describes the basic architecture of kcp and other controllers in this repo that work with kcp to implement the transparent multi-cluster …"><meta property="og:title" content="kcp Multi-Cluster Architecture"><meta property="og:description" content="This doc describes the basic architecture of kcp and other controllers in this repo that work with kcp to implement the transparent multi-cluster demo.
kcp kcp is a minimal Kubernetes API server, that only knows about basic types and CustomResourceDefinitions (CRDs). Its code is found in ./cmd/kcp.
It&rsquo;s responsible for storing data in a connected etcd cluster, and for enforcing RBAC on resources that it stores. Its API allows clients to get, list, create, update, delete and watch resources."><meta property="og:type" content="article"><meta property="og:url" content="https://avinal.space/kcp-dev.github.io/docs/kcp-documenation/architecture/readme/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-09-29T23:46:55+05:30"><meta property="og:site_name" content="kcp"><meta itemprop=name content="kcp Multi-Cluster Architecture"><meta itemprop=description content="This doc describes the basic architecture of kcp and other controllers in this repo that work with kcp to implement the transparent multi-cluster demo.
kcp kcp is a minimal Kubernetes API server, that only knows about basic types and CustomResourceDefinitions (CRDs). Its code is found in ./cmd/kcp.
It&rsquo;s responsible for storing data in a connected etcd cluster, and for enforcing RBAC on resources that it stores. Its API allows clients to get, list, create, update, delete and watch resources."><meta itemprop=dateModified content="2022-09-29T23:46:55+05:30"><meta itemprop=wordCount content="893"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="kcp Multi-Cluster Architecture"><meta name=twitter:description content="This doc describes the basic architecture of kcp and other controllers in this repo that work with kcp to implement the transparent multi-cluster demo.
kcp kcp is a minimal Kubernetes API server, that only knows about basic types and CustomResourceDefinitions (CRDs). Its code is found in ./cmd/kcp.
It&rsquo;s responsible for storing data in a connected etcd cluster, and for enforcing RBAC on resources that it stores. Its API allows clients to get, list, create, update, delete and watch resources."><link rel=preload href=/kcp-dev.github.io/scss/main.min.7fddda0797d02daaff7c832b14faf87d6e7c2a1b246f04f55052bb98bcd47059.css as=style><link href=/kcp-dev.github.io/scss/main.min.7fddda0797d02daaff7c832b14faf87d6e7c2a1b246f04f55052bb98bcd47059.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-00000000-0","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/kcp-dev.github.io/><span class=navbar-logo><svg x="158.6pt" y="152.313pt" width="265.186pt" height="302.244pt" viewBox="158.6 152.313 265.186 302.244" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="1"><title>Group</title><g id="2"><title>Group</title><linearGradient x1="419.787" y1="379.981" x2="295.191" y2="302.451" gradientUnits="userSpaceOnUse" id="5"><stop offset=".527429" style="stop-color:#3cd3f6;stop-opacity:1"/><stop offset="1" style="stop-color:#aaedff;stop-opacity:1"/></linearGradient><defs><title>Shape 27</title><g id="3"><defs><path id="4" d="M423.785 227.874s-132.593 75.561-132.593 75.561.0 151.122.0 151.122 132.593-75.703 132.593-75.703.0-150.98.0-150.98"/></defs><use xlink:href="#4" style="fill:url(#5);fill-opacity:1;fill-rule:evenodd;opacity:1;stroke:none"/></g></defs><use xlink:href="#3"/><linearGradient x1="158.6" y1="341.216" x2="291.192" y2="341.216" gradientUnits="userSpaceOnUse" id="8"><stop style="stop-color:#54ff85;stop-opacity:1"/><stop offset="1" style="stop-color:#aff456;stop-opacity:1"/></linearGradient><defs><title>Shape 28</title><g id="6"><defs><path id="7" d="M291.192 303.435 158.6 227.874s0 151.122.0 151.122 132.592 75.561 132.592 75.561.0-151.122.0-151.122"/></defs><use xlink:href="#7" style="fill:url(#8);fill-opacity:1;fill-rule:evenodd;opacity:1;stroke:none"/></g></defs><use xlink:href="#6"/><linearGradient x1="293.506" y1="152.325" x2="288.878" y2="303.424" gradientUnits="userSpaceOnUse" id="11"><stop offset=".0024966" style="stop-color:#3d50ff;stop-opacity:1"/><stop offset=".40625" style="stop-color:#3d97ff;stop-opacity:1"/><stop offset="1" style="stop-color:#e1d2ff;stop-opacity:1"/></linearGradient><defs><title>Shape 29</title><g id="9"><defs><path id="10" d="M291.192 303.435 158.6 227.874s132.592-75.561 132.592-75.561 132.593 75.561 132.593 75.561-132.593 75.561-132.593 75.561"/></defs><use xlink:href="#10" style="fill:url(#11);fill-opacity:1;fill-rule:evenodd;opacity:1;stroke:none"/></g></defs><use xlink:href="#9"/></g><g id="12"><title>White Overlay</title><defs><title>Smart Polygon Copy Copy</title><g id="13"><defs><path id="14" d="M291.192 227.874s66.297 37.781 66.297 37.781.0 75.561.0 75.561-66.297 37.78-66.297 37.78-66.296-37.78-66.296-37.78.0-75.561.0-75.561 66.296-37.781 66.296-37.781z"/></defs><use xlink:href="#14" style="fill:#fff;fill-opacity:.853805;fill-rule:nonzero;opacity:1;stroke:none"/></g></defs><use xlink:href="#13"/><defs><title>Shape 49</title><g id="15"><defs><path id="16" d="M224.896 341.216v-9.339S158.6 369.349 158.6 369.349 158.6 378.996 158.6 378.996l8.22 4.685S233.817 346.3 233.817 346.3 224.896 341.216 224.896 341.216z"/></defs><use xlink:href="#16" style="fill:#fff;fill-opacity:.895489;fill-rule:evenodd;opacity:1;stroke:none"/></g></defs><use xlink:href="#15"/><defs><title>Shape 49 Copy</title><g id="17"><defs><path id="18" d="M291.192 227.874 299.714 232.713v-75.544S291.192 152.313 291.192 152.313 282.672 157.169 282.672 157.169 282.702 232.713 282.702 232.713 291.192 227.874 291.192 227.874z"/></defs><use xlink:href="#18" style="fill:#fff;fill-opacity:.895489;fill-rule:evenodd;opacity:1;stroke:none"/></g></defs><use xlink:href="#17"/><defs><title>Shape 49 Copy</title><g id="19"><defs><path id="20" d="M357.489 341.216v-9.339S423.785 369.689 423.785 369.689 423.785 378.854 423.785 378.854 415.368 383.66 415.368 383.66l-66.32-37.634L357.489 341.216z"/></defs><use xlink:href="#20" style="fill:#fff;fill-opacity:.895489;fill-rule:evenodd;opacity:1;stroke:none"/></g></defs><use xlink:href="#19"/></g></g></svg></span><span class=font-weight-bold>kcp</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/kcp-dev.github.io/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/kcp-dev.github.io/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-kcp-devgithubiodocs-li><a href=/kcp-dev.github.io/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-kcp-devgithubiodocs><span>Docs</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationauthorization-li><a href=/kcp-dev.github.io/docs/kcp-documenation/authorization/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationauthorization><span>Authorization</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-kcp-devgithubiodocskcp-documenationarchitecturereadme-li><a href=/kcp-dev.github.io/docs/kcp-documenation/architecture/readme/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationarchitecturereadme><span class=td-sidebar-nav-active-item>kcp Multi-Cluster Architecture</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationcluster-mapper-li><a href=/kcp-dev.github.io/docs/kcp-documenation/cluster-mapper/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationcluster-mapper><span>Cluster Mapper</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationkubectl-kcp-plugin-li><a href=/kcp-dev.github.io/docs/kcp-documenation/kubectl-kcp-plugin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationkubectl-kcp-plugin><span>Kubectl KCP Plugin</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationlocations-and-scheduling-li><a href=/kcp-dev.github.io/docs/kcp-documenation/locations-and-scheduling/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationlocations-and-scheduling><span>Locations and Scheduling</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationsyncer-li><a href=/kcp-dev.github.io/docs/kcp-documenation/syncer/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationsyncer><span>Registering kubernetes clusters using syncers</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationterminology-li><a href=/kcp-dev.github.io/docs/kcp-documenation/terminology/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationterminology><span>Terminology for control plane</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationvirtual-workspaces-li><a href=/kcp-dev.github.io/docs/kcp-documenation/virtual-workspaces/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationvirtual-workspaces><span>Virtual Workspaces</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationworkspaces-li><a href=/kcp-dev.github.io/docs/kcp-documenation/workspaces/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationworkspaces><span>Workspaces</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationinvestigationslogical-clusters-li><a href=/kcp-dev.github.io/docs/kcp-documenation/investigations/logical-clusters/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationinvestigationslogical-clusters><span>Logical Clusters</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationinvestigationsminimal-api-server-li><a href=/kcp-dev.github.io/docs/kcp-documenation/investigations/minimal-api-server/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationinvestigationsminimal-api-server><span>Minimal API Server</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationinvestigationsself-service-policy-li><a href=/kcp-dev.github.io/docs/kcp-documenation/investigations/self-service-policy/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationinvestigationsself-service-policy><span>Self-service policy</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kcp-devgithubiodocskcp-documenationinvestigationstransparent-multi-cluster-li><a href=/kcp-dev.github.io/docs/kcp-documenation/investigations/transparent-multi-cluster/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-kcp-devgithubiodocskcp-documenationinvestigationstransparent-multi-cluster><span>Transparent multi-cluster</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/kcp-dev/kcp.io/tree/main/docs/content/en/docs/kcp%20Documenation/architecture/README.md class=td-page-meta--view target=_blank rel=noopener><i class="fa fa-file-alt fa-fw"></i> View page source</a>
<a href=https://github.com/kcp-dev/kcp.io/edit/main/docs/content/en/docs/kcp%20Documenation/architecture/README.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/kcp-dev/kcp.io/new/main/docs/content/en/docs/kcp%20Documenation/architecture/README.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/kcp-dev/kcp.io/issues/new?title=kcp%20Multi-Cluster%20Architecture" class=td-page-meta--issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/kcp-dev/kcp/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#kcp><code>kcp</code></a></li><li><a href=#cluster-crd-and-cluster-controller>Cluster CRD and Cluster Controller</a><ul><li><a href=#crd-puller>CRD Puller</a></li></ul></li><li><a href=#syncer>Syncer</a></li><li><a href=#deployment-splitter>Deployment Splitter</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://avinal.space/kcp-dev.github.io/docs/>Docs</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://avinal.space/kcp-dev.github.io/docs/kcp-documenation/architecture/readme/ aria-disabled=true class="btn-link disabled">kcp Multi-Cluster Architecture</a></li></ol></nav><div class=td-content><h1>kcp Multi-Cluster Architecture</h1><header class=article-meta></header><p>This doc describes the basic architecture of <code>kcp</code> and other controllers in this repo that work with <code>kcp</code> to implement the <a href=../investigations/transparent-multi-cluster.md>transparent multi-cluster</a> demo.</p><h2 id=kcp><code>kcp</code></h2><p><code>kcp</code> is a minimal Kubernetes API server, that only knows about basic types and <code>CustomResourceDefinition</code>s (CRDs).
Its code is found in <code>./cmd/kcp</code>.</p><p>It&rsquo;s responsible for storing data in a connected etcd cluster, and for enforcing RBAC on resources that it stores.
Its API allows clients to get, list, create, update, delete and watch resources.</p><p><img alt="Diagram of kcp" width=30% src=./kcp.png></img></p><p><code>kcp</code> doesn&rsquo;t know about most of the core Kubernetes types (Pods, etc.), and expects users or controllers to define them as needed, and to run controllers to respond to those resources.</p><p><code>kcp</code> doesn&rsquo;t support validating or mutating <a href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/>admission controllers</a> at this time.</p><p><code>kcp</code> is currently configured to create a new local etcd cluster at startup if one does not already exist.
In the future, flags will allow <code>kcp</code> to connect to an existing remote etcd cluster.</p><p>If all you want is a <a href=../investigations/minimal-api-server.md>minimal API server</a>, that talks a Kubernetes-style API and stores and serves data for you, you can stop now.
The rest of this doc describes additional components you can run with <code>kcp</code> to achieve transparent multi-cluster scheduling.</p><h2 id=cluster-crd-and-cluster-controller>Cluster CRD and Cluster Controller</h2><p>The example <a href=../../config/workload.kcp.dev_clusters.yaml>Cluster</a> CRD type holds information to reach and authenticate to another Kubernetes cluster&rsquo;s API server.
To do this, its <code>.spec.kubeconfig</code> field defines a YAML serialized <a href=https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig</a> file.</p><p><strong>NB:</strong> A kubeconfig contains sensitive information to authenticate with a cluster&rsquo;s API server.
In the fullness of time we need a more secure mechanism for registering and authenticating to a cluster.</p><p>With the Cluster type defined, users can create Cluster resources to tell <code>kcp</code> about their clusters.</p><p>The Cluster Controller (<code>./cmd/cluster-controller</code>) connects to <code>kcp</code> and watches for new Cluster resources that get defined.
When a new resource is seen, the controller uses its <code>.spec.kubeconfig</code> to connect to the cluster and start a <a href=#syncer>Syncer</a>.</p><h3 id=crd-puller>CRD Puller</h3><p>Before starting the Syncer, and continuously while it&rsquo;s connected to the cluster, the Cluster Controller watches the cluster&rsquo;s API resources to discover new types and updates to existing types.
The Cluster Controller uses this information to negotiate possible incompatible CRD type definitions, to determine whether an incoming resource can be sent to a cluster&rsquo;s Syncer.</p><p><img alt="Diagram of kcp and Cluster Controller" width=50% src=./cluster-controller.png></img></p><p><strong>NB:</strong> In these diagrams, controllers are depicted as separate, external boxes.
In reality, these control loops could be compiled in and embedded into the same binary as <code>kcp</code>, or run as remote external services.</p><h2 id=syncer>Syncer</h2><p>The Syncer (<code>./cmd/syncer</code>) maintains a connection to the <code>kcp</code>, and to a Kubernetes cluster&rsquo;s API server.</p><p>After initial type negotiation, the Syncer watches for resources of all types that are scheduled to that cluster, using the <code>workloads.kcp.dev/cluster</code> label, and copies those resources to the Kubernetes cluster.</p><p>It also watches for updates to resources in its cluster, and mirrors any updates to <code>.status</code> to the <code>kcp</code>&rsquo;s API.</p><p><img alt="Diagram of kcp, Cluster Controller and Syncer" src=./syncer.png></img></p><p><strong>NB:</strong> Syncer can run in one of three modes, determined by a flag given to the Cluster Controller that starts Syncers:</p><ol><li>In <code>--pull</code> mode (pictured), the Syncer runs as a Pod inside the downstream cluster, communicating with the cluster&rsquo;s API server from inside the cluster.</li><li>In <code>--push</code> mode, Syncers run as goroutines in the Cluster Controller binary, communicating with the cluster&rsquo;s API server from outside the cluster.</li><li>In &ldquo;none&rdquo; mode, operators are expected to run the Syncer as a separate process. This is mainly to aid debugging.</li></ol><p>There is ongoing discussion about where Syncers should run, and the answer might be &ldquo;either inside or outside the cluster&rdquo;.
Its code should be structured to be agnostic to this distinction, since it only needs to be given two kubeconfigs, wherever it runs.</p><p>If the in-cluster Syncer ever becomes unreachable, or out-of-cluster Syncer fails to reach the downstream cluster, the Cluster&rsquo;s <code>.status.conditions</code> is update to indicate that the Cluster is not <code>Ready</code>.</p><h2 id=deployment-splitter>Deployment Splitter</h2><p>The Deployment Splitter (<code>./cmd/deployment-splitter</code>) is an example of a very simple multi-cluster resource scheduler.
It watches for <code>Deployment</code> resources in the <code>kcp</code>, and determines how many of that Deployment&rsquo;s <code>replicas</code> should be scheduled to which of the available Cluster resources.</p><p>It currently does this very <em>very</em> simply, by dividing the number of <code>replicas</code> evenly across available clusters.</p><p>When the Deployment Splitter splits a Deployment, it creates N new Deployment resources, each labeled for an available cluster (i.e., it labels each with <code>workloads.kcp.dev/cluster: my-cluster-name</code>).
This in turn instructs the <a href=#syncer>Syncer</a> for that cluster to see the Deployment shard and sync it down to the cluster.</p><p><img alt="Diagram of kcp, Cluster Controller, Syncer and Deployment Splitter" src=./deployment-splitter.png></img></p><p>The Deployment Splitter is <em>very simple</em>, and would need lots of improvements to make it usable in a real production scenario:</p><ul><li>it should take into account whether the Cluster reports as <code>Ready</code>, in case the Syncer is having difficulty syncing to the cluster.</li><li>it should take into account user provided scheduling hints such as affinity, anti-affinity, etc.</li><li>it should take into account resources&rsquo; dependencies and schedule dependent resources to the same cluster.</li><li>it should continuously watch for new Cluster resources, to take advantage of those new resources and rebalance existing scheduling decisions.</li><li>it should continuously watch for existing Cluster resources to report as not <code>Ready</code>, to unschedule resources from those clusters.</li><li>it should become more generic, so that it can schedule resources of all types (e.g., <code>DaemonSet</code>s, <code>StatefulSet</code>s, <code>PersistentVolume</code>s, CRDs of all kinds).</li></ul><hr><p>Taken together, these components are designed to work in concert to provide a robust system for scheduling generic resources across multiple clusters.</p><div class="text-muted mt-5 pt-3 border-top">Last modified September 29, 2022: <a href=https://github.com/kcp-dev/kcp.io/commit/5d0ae19ec8d23dc3c2358774007d8e2e01b9fce5>test kcp site (5d0ae19)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/kcp-users aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/kcp aria-label=Twitter><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/kcp-dev/kcp aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel=noopener href=https://kubernetes.slack.com/archives/C021U8WSAFK aria-label=Slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/kcp-dev aria-label="Developer mailing list"><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The kcp Authors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/kcp-dev.github.io/js/main.min.3f62c175a8054b314be5ce520b3bfc720d9bae5e37454ddaf26d4bdf23fef7b4.js integrity="sha256-P2LBdagFSzFL5c5SCzv8cg2brl43RU3a8m1L3yP+97Q=" crossorigin=anonymous></script></body></html>